version: '3.9'

services:
  smtp:
    image: boky/postfix
    restart: always
    ports: ['127.0.0.1:1587:587']
    volumes:
      - ./.tmp/opendkim-keys:/etc/opendkim/keys
      - ./.tmp/var/spool/postfix:/var/spool/postfix # to persist queue during container restarts
    environment:
      TZ: UTC
      ALLOWED_SENDER_DOMAINS: feedsubscription.com
    logging:
      driver: local
    healthcheck:
      disable: true # Disabled because makes it makes following the logs harder when degugging

  smtp-in:
    image: zixia/simple-mail-forwarder
    ports: ['25:25']
    restart: always
    environment:
      SMF_CONFIG: '@feedsubscription.com:gurdiga@gmail.com'
    logging:
      driver: local

  app:
    image: app
    init: true # This is to tell Node process to stop when the container is asked to stop.
    volumes:
      - .tmp/docker-data:/data
    environment:
      TZ: UTC
      NODE_ENV: production #See https://github.com/nodejs/docker-node/blob/main/docs/BestPractices.md
      SMTP_CONNECTION_STRING: smtp://smtp:587
      DATA_DIR_ROOT: /data
      APP_BASE_URL: https://feedsubscription.com
    logging:
      driver: local
